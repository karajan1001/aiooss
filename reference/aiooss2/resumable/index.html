
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../../assets/logo.svg">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.4.1">
    
    
      
        <title>Resumable - Aiooss2</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.69437709.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#ffffff">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="white" data-md-color-accent="deep-purple">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#aiooss2.resumable" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Aiooss2" class="md-header__button md-logo" aria-label="Aiooss2" data-md-component="logo">
      
  <img src="../../../assets/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Aiooss2
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Resumable
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/iterative/aiooss2" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    iterative/aiooss2
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Aiooss2" class="md-nav__button md-logo" aria-label="Aiooss2" data-md-component="logo">
      
  <img src="../../../assets/logo.svg" alt="logo">

    </a>
    Aiooss2
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/iterative/aiooss2" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    iterative/aiooss2
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Welcome to Aiooss2
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" checked>
      
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../">Aiooss2</a>
          
            <label for="__nav_2_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Aiooss2" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Aiooss2
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../adapter/" class="md-nav__link">
        Adapter
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        Api
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../exceptions/" class="md-nav__link">
        Exceptions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../http/" class="md-nav__link">
        Http
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../iterators/" class="md-nav__link">
        Iterators
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        Models
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../multipart/" class="md-nav__link">
        Multipart
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Resumable
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Resumable
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#aiooss2.resumable" class="md-nav__link">
    aiooss2.resumable
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aiooss2.resumable.ResumableDownloader" class="md-nav__link">
    ResumableDownloader
  </a>
  
    <nav class="md-nav" aria-label="ResumableDownloader">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.ResumableDownloader.download" class="md-nav__link">
    download()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aiooss2.resumable.ResumableUploader" class="md-nav__link">
    ResumableUploader
  </a>
  
    <nav class="md-nav" aria-label="ResumableUploader">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.ResumableUploader.init_record" class="md-nav__link">
    init_record()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.ResumableUploader.upload" class="md-nav__link">
    upload()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_download" class="md-nav__link">
    resumable_download()
  </a>
  
    <nav class="md-nav" aria-label="resumable_download()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_download--using-cryptobucket-will-make-the-download-fallback-to-the-normal-one" class="md-nav__link">
    Using CryptoBucket will make the download fallback to the normal one.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_download--avoid-using-multi-threadingprocessing-as-the-temp-downloaded-file-might" class="md-nav__link">
    Avoid using multi-threading/processing as the temp downloaded file might
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_download--be-covered" class="md-nav__link">
    be covered.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_download--download_part-only-accept-oss_request_payer" class="md-nav__link">
    download_part only accept OSS_REQUEST_PAYER
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_download--get_object-and-get_object_to_file-only-accept-oss_request_payer" class="md-nav__link">
    get_object and get_object_to_file only accept OSS_REQUEST_PAYER,
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_upload" class="md-nav__link">
    resumable_upload()
  </a>
  
    <nav class="md-nav" aria-label="resumable_upload()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_upload--using-cryptobucket-will-make-the-upload-fallback-to-the-normal-one" class="md-nav__link">
    Using CryptoBucket will make the upload fallback to the normal one.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_upload--put_object-or-init_multipart_upload-can-make-use-of-the-whole" class="md-nav__link">
    put_object or init_multipart_upload can make use of the whole
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_upload--uplpad_part-only-accept-oss_request_payer-oss_traffic_limit" class="md-nav__link">
    uplpad_part only accept OSS_REQUEST_PAYER, OSS_TRAFFIC_LIMIT
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_upload--complete_multipart_upload-only-accept-oss_request_payer" class="md-nav__link">
    complete_multipart_upload only accept OSS_REQUEST_PAYER,
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        Utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#aiooss2.resumable" class="md-nav__link">
    aiooss2.resumable
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aiooss2.resumable.ResumableDownloader" class="md-nav__link">
    ResumableDownloader
  </a>
  
    <nav class="md-nav" aria-label="ResumableDownloader">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.ResumableDownloader.download" class="md-nav__link">
    download()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aiooss2.resumable.ResumableUploader" class="md-nav__link">
    ResumableUploader
  </a>
  
    <nav class="md-nav" aria-label="ResumableUploader">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.ResumableUploader.init_record" class="md-nav__link">
    init_record()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.ResumableUploader.upload" class="md-nav__link">
    upload()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_download" class="md-nav__link">
    resumable_download()
  </a>
  
    <nav class="md-nav" aria-label="resumable_download()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_download--using-cryptobucket-will-make-the-download-fallback-to-the-normal-one" class="md-nav__link">
    Using CryptoBucket will make the download fallback to the normal one.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_download--avoid-using-multi-threadingprocessing-as-the-temp-downloaded-file-might" class="md-nav__link">
    Avoid using multi-threading/processing as the temp downloaded file might
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_download--be-covered" class="md-nav__link">
    be covered.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_download--download_part-only-accept-oss_request_payer" class="md-nav__link">
    download_part only accept OSS_REQUEST_PAYER
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_download--get_object-and-get_object_to_file-only-accept-oss_request_payer" class="md-nav__link">
    get_object and get_object_to_file only accept OSS_REQUEST_PAYER,
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_upload" class="md-nav__link">
    resumable_upload()
  </a>
  
    <nav class="md-nav" aria-label="resumable_upload()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_upload--using-cryptobucket-will-make-the-upload-fallback-to-the-normal-one" class="md-nav__link">
    Using CryptoBucket will make the upload fallback to the normal one.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_upload--put_object-or-init_multipart_upload-can-make-use-of-the-whole" class="md-nav__link">
    put_object or init_multipart_upload can make use of the whole
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_upload--uplpad_part-only-accept-oss_request_payer-oss_traffic_limit" class="md-nav__link">
    uplpad_part only accept OSS_REQUEST_PAYER, OSS_TRAFFIC_LIMIT
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aiooss2.resumable.resumable_upload--complete_multipart_upload-only-accept-oss_request_payer" class="md-nav__link">
    complete_multipart_upload only accept OSS_REQUEST_PAYER,
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/iterative/aiooss2/edit/master/docs/src/aiooss2/resumable.py" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>Resumable</h1>

<div class="doc doc-object doc-module">


<a id="aiooss2.resumable"></a>
  <div class="doc doc-contents first">
  
      <p>Module for resumable operations</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="aiooss2.resumable.ResumableDownloader" class="doc doc-heading">
        <code>ResumableDownloader</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="oss2.resumable._ResumableDownloader">_ResumableDownloader</span></code></p>

  
      <p>Resumable Downloader</p>


        <details class="quote">
          <summary>Source code in <code>aiooss2/resumable.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ResumableDownloader</span><span class="p">(</span><span class="n">_ResumableDownloader</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resumable Downloader&quot;&quot;&quot;</span>

    <span class="n">bucket</span><span class="p">:</span> <span class="s2">&quot;AioBucket&quot;</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">download</span><span class="p">(</span>  <span class="c1"># pylint: disable=invalid-overridden-method</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">server_crc</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resumable download object from oss server to a local file.</span>

<span class="sd">        Args:</span>
<span class="sd">            server_crc (_type_, optional): _description_. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__load_record</span><span class="p">()</span>

        <span class="n">parts_to_download</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_parts_to_download</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Parts need to download: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parts_to_download</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tmp_file</span><span class="p">,</span> <span class="s2">&quot;ab&quot;</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__num_threads</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_download_task</span><span class="p">(</span><span class="n">sem</span><span class="p">,</span> <span class="n">part_to_download</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">part_to_download</span> <span class="ow">in</span> <span class="n">parts_to_download</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">enable_crc</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__finished_parts</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">part_number</span><span class="p">)</span>
            <span class="n">object_crc</span> <span class="o">=</span> <span class="n">calc_obj_crc_from_parts</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
            <span class="n">check_crc</span><span class="p">(</span><span class="s2">&quot;resume download&quot;</span><span class="p">,</span> <span class="n">object_crc</span><span class="p">,</span> <span class="n">server_crc</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">force_rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tmp_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_report_progress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_del_record</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_download_task</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sem</span><span class="p">:</span> <span class="s2">&quot;asyncio.Semaphore&quot;</span><span class="p">,</span> <span class="n">part_to_upload</span><span class="p">:</span> <span class="n">_PartToProcess</span>
    <span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">sem</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_part</span><span class="p">(</span><span class="n">part_to_upload</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_download_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">:</span> <span class="n">_PartToProcess</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_report_progress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__finished_size</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tmp_file</span><span class="p">,</span> <span class="s2">&quot;rb+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_r</span><span class="p">:</span>
            <span class="n">f_r</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_SET</span><span class="p">)</span>

            <span class="n">headers</span> <span class="o">=</span> <span class="n">_populate_valid_headers</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__headers</span><span class="p">,</span> <span class="p">[</span><span class="n">OSS_REQUEST_PAYER</span><span class="p">,</span> <span class="n">OSS_TRAFFIC_LIMIT</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="n">CaseInsensitiveDict</span><span class="p">()</span>
            <span class="n">headers</span><span class="p">[</span><span class="n">IF_MATCH</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectInfo</span><span class="o">.</span><span class="n">etag</span>
            <span class="n">headers</span><span class="p">[</span><span class="n">IF_UNMODIFIED_SINCE</span><span class="p">]</span> <span class="o">=</span> <span class="n">http_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectInfo</span><span class="o">.</span><span class="n">mtime</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
                <span class="n">byte_range</span><span class="o">=</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__params</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">copyfileobj_and_verify</span><span class="p">(</span>
                <span class="n">result</span><span class="p">,</span>
                <span class="n">f_r</span><span class="p">,</span>
                <span class="n">part</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">part</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">part</span><span class="o">.</span><span class="n">part_crc</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">client_crc</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;down part success, add part info to record, part_number:&quot;</span>
            <span class="s2">&quot; </span><span class="si">%s</span><span class="s2">, start: </span><span class="si">%s</span><span class="s2">, end: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">part</span><span class="o">.</span><span class="n">part_number</span><span class="p">,</span>
            <span class="n">part</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
            <span class="n">part</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__finish_part</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="aiooss2.resumable.ResumableDownloader.download" class="doc doc-heading">
<code class="highlight language-python"><span class="n">download</span><span class="p">(</span><span class="n">server_crc</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Resumable download object from oss server to a local file.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>server_crc</code></td>
          <td>
                <code>_type_</code>
          </td>
          <td><p><em>description</em>. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>aiooss2/resumable.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">download</span><span class="p">(</span>  <span class="c1"># pylint: disable=invalid-overridden-method</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">server_crc</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resumable download object from oss server to a local file.</span>

<span class="sd">    Args:</span>
<span class="sd">        server_crc (_type_, optional): _description_. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__load_record</span><span class="p">()</span>

    <span class="n">parts_to_download</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_parts_to_download</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Parts need to download: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parts_to_download</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tmp_file</span><span class="p">,</span> <span class="s2">&quot;ab&quot;</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__num_threads</span><span class="p">)</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_download_task</span><span class="p">(</span><span class="n">sem</span><span class="p">,</span> <span class="n">part_to_download</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">part_to_download</span> <span class="ow">in</span> <span class="n">parts_to_download</span>
    <span class="p">]</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">enable_crc</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__finished_parts</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">part_number</span><span class="p">)</span>
        <span class="n">object_crc</span> <span class="o">=</span> <span class="n">calc_obj_crc_from_parts</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="n">check_crc</span><span class="p">(</span><span class="s2">&quot;resume download&quot;</span><span class="p">,</span> <span class="n">object_crc</span><span class="p">,</span> <span class="n">server_crc</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">force_rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tmp_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_report_progress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_del_record</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="aiooss2.resumable.ResumableUploader" class="doc doc-heading">
        <code>ResumableUploader</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="oss2.resumable._ResumableUploader">_ResumableUploader</span></code></p>

  
      <p>Resumable Uploader</p>


        <details class="quote">
          <summary>Source code in <code>aiooss2/resumable.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ResumableUploader</span><span class="p">(</span><span class="n">_ResumableUploader</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resumable Uploader&quot;&quot;&quot;</span>

    <span class="n">bucket</span><span class="p">:</span> <span class="s2">&quot;AioBucket&quot;</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">upload</span><span class="p">(</span>  <span class="c1"># pylint: disable=invalid-overridden-method</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PutObjectResult&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;resumable upload file to oss storage</span>

<span class="sd">        Returns:</span>
<span class="sd">            PutObjectResult:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_record</span><span class="p">()</span>

        <span class="n">parts_to_upload</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span>
            <span class="s2">&quot;_PartToProcess&quot;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_parts_to_upload</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__finished_parts</span><span class="p">)</span>
        <span class="n">parts_to_upload</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">parts_to_upload</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">part_number</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Parts need to upload: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parts_to_upload</span><span class="p">)</span>

        <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__num_threads</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_upload_task</span><span class="p">(</span><span class="n">sem</span><span class="p">,</span> <span class="n">part_to_upload</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">part_to_upload</span> <span class="ow">in</span> <span class="n">parts_to_upload</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_report_progress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="n">_populate_valid_headers</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__headers</span><span class="p">,</span> <span class="p">[</span><span class="n">OSS_REQUEST_PAYER</span><span class="p">,</span> <span class="n">OSS_OBJECT_ACL</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">complete_multipart_upload</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__upload_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__finished_parts</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_del_record</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_upload_task</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sem</span><span class="p">:</span> <span class="s2">&quot;asyncio.Semaphore&quot;</span><span class="p">,</span> <span class="n">part_to_upload</span><span class="p">:</span> <span class="n">_PartToProcess</span>
    <span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">sem</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upload_part</span><span class="p">(</span><span class="n">part_to_upload</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_upload_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">:</span> <span class="n">_PartToProcess</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">to_unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_r</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_report_progress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__finished_size</span><span class="p">)</span>

            <span class="n">f_r</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_SET</span><span class="p">)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="n">_populate_valid_headers</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__headers</span><span class="p">,</span> <span class="p">[</span><span class="n">OSS_REQUEST_PAYER</span><span class="p">,</span> <span class="n">OSS_TRAFFIC_LIMIT</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__encryption</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">upload_part</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__upload_id</span><span class="p">,</span>
                    <span class="n">part</span><span class="o">.</span><span class="n">part_number</span><span class="p">,</span>
                    <span class="n">FilelikeObjectAdapter</span><span class="p">(</span><span class="n">f_r</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">part</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                    <span class="n">upload_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__upload_context</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">upload_part</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__upload_id</span><span class="p">,</span>
                    <span class="n">part</span><span class="o">.</span><span class="n">part_number</span><span class="p">,</span>
                    <span class="n">FilelikeObjectAdapter</span><span class="p">(</span><span class="n">f_r</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">part</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Upload part success, add part info to record, part_number: &quot;</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, etag: </span><span class="si">%s</span><span class="s2">, size: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">part</span><span class="o">.</span><span class="n">part_number</span><span class="p">,</span>
                <span class="n">result</span><span class="o">.</span><span class="n">etag</span><span class="p">,</span>
                <span class="n">part</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__finish_part</span><span class="p">(</span>
                <span class="n">PartInfo</span><span class="p">(</span>
                    <span class="n">part</span><span class="o">.</span><span class="n">part_number</span><span class="p">,</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">etag</span><span class="p">,</span>
                    <span class="n">size</span><span class="o">=</span><span class="n">part</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                    <span class="n">part_crc</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">crc</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">record</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_record_sane</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;The content of record is invalid, delete the record&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_del_record</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">record</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__file_changed</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;File: </span><span class="si">%s</span><span class="s2"> has been changed, delete the record&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_del_record</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">record</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__upload_exists</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;upload_id&quot;</span><span class="p">]):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Multipart upload: </span><span class="si">%s</span><span class="s2"> does not exist, delete the record&quot;</span><span class="p">,</span>
                <span class="n">record</span><span class="p">[</span><span class="s2">&quot;upload_id&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_del_record</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">record</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">init_record</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialization record for the file to upload.&quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">_populate_valid_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__params</span><span class="p">,</span> <span class="p">[</span><span class="n">Bucket</span><span class="o">.</span><span class="n">SEQUENTIAL</span><span class="p">])</span>
        <span class="n">part_size</span> <span class="o">=</span> <span class="n">determine_part_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__part_size</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Upload File size: </span><span class="si">%d</span><span class="s2">, User-specify part_size: </span><span class="si">%d</span><span class="s2">, &quot;</span>
            <span class="s2">&quot;Calculated part_size: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__part_size</span><span class="p">,</span>
            <span class="n">part_size</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__encryption</span><span class="p">:</span>
            <span class="n">upload_context</span> <span class="o">=</span> <span class="n">MultipartUploadCryptoContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">part_size</span><span class="p">)</span>
            <span class="n">init_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">init_multipart_upload</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__headers</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">upload_context</span>
            <span class="p">)</span>
            <span class="n">upload_id</span> <span class="o">=</span> <span class="n">init_result</span><span class="o">.</span><span class="n">upload_id</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__record_upload_context</span><span class="p">:</span>
                <span class="n">material</span> <span class="o">=</span> <span class="n">upload_context</span><span class="o">.</span><span class="n">content_crypto_material</span>
                <span class="n">material_record</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;wrap_alg&quot;</span><span class="p">:</span> <span class="n">material</span><span class="o">.</span><span class="n">wrap_alg</span><span class="p">,</span>
                    <span class="s2">&quot;cek_alg&quot;</span><span class="p">:</span> <span class="n">material</span><span class="o">.</span><span class="n">cek_alg</span><span class="p">,</span>
                    <span class="s2">&quot;encrypted_key&quot;</span><span class="p">:</span> <span class="n">b64encode_as_string</span><span class="p">(</span>
                        <span class="n">material</span><span class="o">.</span><span class="n">encrypted_key</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;encrypted_iv&quot;</span><span class="p">:</span> <span class="n">b64encode_as_string</span><span class="p">(</span><span class="n">material</span><span class="o">.</span><span class="n">encrypted_iv</span><span class="p">),</span>
                    <span class="s2">&quot;mat_desc&quot;</span><span class="p">:</span> <span class="n">material</span><span class="o">.</span><span class="n">mat_desc</span><span class="p">,</span>
                <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">init_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">init_multipart_upload</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__headers</span><span class="p">,</span> <span class="n">params</span>
            <span class="p">)</span>
            <span class="n">upload_id</span> <span class="o">=</span> <span class="n">init_result</span><span class="o">.</span><span class="n">upload_id</span>

        <span class="n">record</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;op_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__op</span><span class="p">,</span>
            <span class="s2">&quot;upload_id&quot;</span><span class="p">:</span> <span class="n">upload_id</span><span class="p">,</span>
            <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abspath</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="s2">&quot;mtime&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mtime</span><span class="p">,</span>
            <span class="s2">&quot;bucket&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
            <span class="s2">&quot;part_size&quot;</span><span class="p">:</span> <span class="n">part_size</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__record_upload_context</span><span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="s2">&quot;content_crypto_material&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">material_record</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Add new record, bucket: </span><span class="si">%s</span><span class="s2">, key: </span><span class="si">%s</span><span class="s2">, upload_id: </span><span class="si">%s</span><span class="s2">, &quot;</span>
            <span class="s2">&quot;part_size: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
            <span class="n">upload_id</span><span class="p">,</span>
            <span class="n">part_size</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_put_record</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">record</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_get_finished_parts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">valid_headers</span> <span class="o">=</span> <span class="n">_filter_invalid_headers</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__headers</span><span class="p">,</span>
            <span class="p">[</span><span class="n">OSS_SERVER_SIDE_ENCRYPTION</span><span class="p">,</span> <span class="n">OSS_SERVER_SIDE_DATA_ENCRYPTION</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">async</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">AioPartIterator</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__upload_id</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">valid_headers</span>
        <span class="p">):</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parts</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_load_record</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">record</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_record</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Load record return </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>

        <span class="n">record</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_record</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

        <span class="n">record</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">record</span> <span class="ow">or</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_record</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__record</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">record</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__part_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__record</span><span class="p">[</span><span class="s2">&quot;part_size&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__upload_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__record</span><span class="p">[</span><span class="s2">&quot;upload_id&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__record_upload_context</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;content_crypto_material&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__record</span><span class="p">:</span>
                <span class="n">material_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__record</span><span class="p">[</span><span class="s2">&quot;content_crypto_material&quot;</span><span class="p">]</span>
                <span class="n">wrap_alg</span> <span class="o">=</span> <span class="n">material_record</span><span class="p">[</span><span class="s2">&quot;wrap_alg&quot;</span><span class="p">]</span>
                <span class="n">cek_alg</span> <span class="o">=</span> <span class="n">material_record</span><span class="p">[</span><span class="s2">&quot;cek_alg&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">cek_alg</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">crypto_provider</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">alg</span>
                    <span class="ow">or</span> <span class="n">wrap_alg</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">crypto_provider</span><span class="o">.</span><span class="n">wrap_alg</span>
                <span class="p">):</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;Envelope or data encryption/decryption &quot;</span>
                        <span class="s2">&quot;algorithm is inconsistent&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">InconsistentError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="n">content_crypto_material</span> <span class="o">=</span> <span class="n">ContentCryptoMaterial</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">crypto_provider</span><span class="o">.</span><span class="n">cipher</span><span class="p">,</span>
                    <span class="n">material_record</span><span class="p">[</span><span class="s2">&quot;wrap_alg&quot;</span><span class="p">],</span>
                    <span class="n">b64decode_from_string</span><span class="p">(</span><span class="n">material_record</span><span class="p">[</span><span class="s2">&quot;encrypted_key&quot;</span><span class="p">]),</span>
                    <span class="n">b64decode_from_string</span><span class="p">(</span><span class="n">material_record</span><span class="p">[</span><span class="s2">&quot;encrypted_iv&quot;</span><span class="p">]),</span>
                    <span class="n">material_record</span><span class="p">[</span><span class="s2">&quot;mat_desc&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__upload_context</span> <span class="o">=</span> <span class="n">MultipartUploadCryptoContext</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__part_size</span><span class="p">,</span> <span class="n">content_crypto_material</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;If record_upload_context flag is true, &quot;</span>
                    <span class="s2">&quot;content_crypto_material must in the the record&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">InconsistentError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;content_crypto_material&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__record</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;content_crypto_material must in the the record, &quot;</span>
                    <span class="s2">&quot;but record_upload_context flat is false&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">InvalidEncryptionRequest</span><span class="p">(</span><span class="n">err_msg</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__finished_parts</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_finished_parts</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__finished_size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__finished_parts</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="aiooss2.resumable.ResumableUploader.init_record" class="doc doc-heading">
<code class="highlight language-python"><span class="n">init_record</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialization record for the file to upload.</p>

      <details class="quote">
        <summary>Source code in <code>aiooss2/resumable.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">init_record</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialization record for the file to upload.&quot;&quot;&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">_populate_valid_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__params</span><span class="p">,</span> <span class="p">[</span><span class="n">Bucket</span><span class="o">.</span><span class="n">SEQUENTIAL</span><span class="p">])</span>
    <span class="n">part_size</span> <span class="o">=</span> <span class="n">determine_part_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__part_size</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Upload File size: </span><span class="si">%d</span><span class="s2">, User-specify part_size: </span><span class="si">%d</span><span class="s2">, &quot;</span>
        <span class="s2">&quot;Calculated part_size: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__part_size</span><span class="p">,</span>
        <span class="n">part_size</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__encryption</span><span class="p">:</span>
        <span class="n">upload_context</span> <span class="o">=</span> <span class="n">MultipartUploadCryptoContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">part_size</span><span class="p">)</span>
        <span class="n">init_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">init_multipart_upload</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__headers</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">upload_context</span>
        <span class="p">)</span>
        <span class="n">upload_id</span> <span class="o">=</span> <span class="n">init_result</span><span class="o">.</span><span class="n">upload_id</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__record_upload_context</span><span class="p">:</span>
            <span class="n">material</span> <span class="o">=</span> <span class="n">upload_context</span><span class="o">.</span><span class="n">content_crypto_material</span>
            <span class="n">material_record</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;wrap_alg&quot;</span><span class="p">:</span> <span class="n">material</span><span class="o">.</span><span class="n">wrap_alg</span><span class="p">,</span>
                <span class="s2">&quot;cek_alg&quot;</span><span class="p">:</span> <span class="n">material</span><span class="o">.</span><span class="n">cek_alg</span><span class="p">,</span>
                <span class="s2">&quot;encrypted_key&quot;</span><span class="p">:</span> <span class="n">b64encode_as_string</span><span class="p">(</span>
                    <span class="n">material</span><span class="o">.</span><span class="n">encrypted_key</span>
                <span class="p">),</span>
                <span class="s2">&quot;encrypted_iv&quot;</span><span class="p">:</span> <span class="n">b64encode_as_string</span><span class="p">(</span><span class="n">material</span><span class="o">.</span><span class="n">encrypted_iv</span><span class="p">),</span>
                <span class="s2">&quot;mat_desc&quot;</span><span class="p">:</span> <span class="n">material</span><span class="o">.</span><span class="n">mat_desc</span><span class="p">,</span>
            <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">init_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">init_multipart_upload</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__headers</span><span class="p">,</span> <span class="n">params</span>
        <span class="p">)</span>
        <span class="n">upload_id</span> <span class="o">=</span> <span class="n">init_result</span><span class="o">.</span><span class="n">upload_id</span>

    <span class="n">record</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;op_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__op</span><span class="p">,</span>
        <span class="s2">&quot;upload_id&quot;</span><span class="p">:</span> <span class="n">upload_id</span><span class="p">,</span>
        <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abspath</span><span class="p">,</span>
        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
        <span class="s2">&quot;mtime&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mtime</span><span class="p">,</span>
        <span class="s2">&quot;bucket&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
        <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
        <span class="s2">&quot;part_size&quot;</span><span class="p">:</span> <span class="n">part_size</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__record_upload_context</span><span class="p">:</span>
        <span class="n">record</span><span class="p">[</span><span class="s2">&quot;content_crypto_material&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">material_record</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Add new record, bucket: </span><span class="si">%s</span><span class="s2">, key: </span><span class="si">%s</span><span class="s2">, upload_id: </span><span class="si">%s</span><span class="s2">, &quot;</span>
        <span class="s2">&quot;part_size: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
        <span class="n">upload_id</span><span class="p">,</span>
        <span class="n">part_size</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_put_record</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">record</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="aiooss2.resumable.ResumableUploader.upload" class="doc doc-heading">
<code class="highlight language-python"><span class="n">upload</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>resumable upload file to oss storage</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>PutObjectResult</code></td>          <td>
                <code><span title="oss2.models.PutObjectResult">PutObjectResult</span></code>
          </td>
          <td></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>aiooss2/resumable.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">upload</span><span class="p">(</span>  <span class="c1"># pylint: disable=invalid-overridden-method</span>
    <span class="bp">self</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PutObjectResult&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;resumable upload file to oss storage</span>

<span class="sd">    Returns:</span>
<span class="sd">        PutObjectResult:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_record</span><span class="p">()</span>

    <span class="n">parts_to_upload</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span>
        <span class="s2">&quot;_PartToProcess&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_parts_to_upload</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__finished_parts</span><span class="p">)</span>
    <span class="n">parts_to_upload</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">parts_to_upload</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">part_number</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Parts need to upload: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parts_to_upload</span><span class="p">)</span>

    <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__num_threads</span><span class="p">)</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_upload_task</span><span class="p">(</span><span class="n">sem</span><span class="p">,</span> <span class="n">part_to_upload</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">part_to_upload</span> <span class="ow">in</span> <span class="n">parts_to_upload</span>
    <span class="p">]</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_report_progress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="n">_populate_valid_headers</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__headers</span><span class="p">,</span> <span class="p">[</span><span class="n">OSS_REQUEST_PAYER</span><span class="p">,</span> <span class="n">OSS_OBJECT_ACL</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">complete_multipart_upload</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__upload_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__finished_parts</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_del_record</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="aiooss2.resumable.resumable_download" class="doc doc-heading">
<code class="highlight language-python"><span class="n">resumable_download</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">part_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multiget_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Resumable download object to local file, implementation method is to
create a list temporary files whose name is formed by the original
filename with some random surfix. If the downloading was interrupted by
some reasons, only those remaied parts need to be downloaded.</p>
<h3 id="aiooss2.resumable.resumable_download--using-cryptobucket-will-make-the-download-fallback-to-the-normal-one">Using <code>CryptoBucket</code> will make the download fallback to the normal one.</h3>
<h3 id="aiooss2.resumable.resumable_download--avoid-using-multi-threadingprocessing-as-the-temp-downloaded-file-might">Avoid using multi-threading/processing as the temp downloaded file might</h3>
<h3 id="aiooss2.resumable.resumable_download--be-covered">be covered.</h3>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>bucket</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<a class="autorefs autorefs-internal" title="aiooss2.api.AioBucket" href="../api/#aiooss2.api.AioBucket">AioBucket</a>, <span title="oss2.CryptoBucket">CryptoBucket</span>]</code>
          </td>
          <td><p>bucket object to download</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>key</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[str, bytes]</code>
          </td>
          <td><p>object key to store the file</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>filename</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[str, bytes]</code>
          </td>
          <td><p>filename to download</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>store</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="oss2.resumable.ResumableStore">ResumableStore</span>]</code>
          </td>
          <td><p>ResumableStore object to keep the
downloading info in the previous operation.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>headers</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Mapping">Mapping</span>]</code>
          </td>
          <td><p>HTTP headers to send. Defaults to None.</p>
<h3 id="aiooss2.resumable.resumable_download--download_part-only-accept-oss_request_payer">download_part only accept OSS_REQUEST_PAYER</h3>
<h3 id="aiooss2.resumable.resumable_download--get_object-and-get_object_to_file-only-accept-oss_request_payer">get_object and get_object_to_file only accept OSS_REQUEST_PAYER,</h3>
<pre><code>OSS_TRAFFIC_LIMIT
</code></pre></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>multipget_threshold</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>threshold to use multipart
download instead of a normal one.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>part_size</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>partition size of the multipart.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>progress_callback</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>]</code>
          </td>
          <td><p>callback function for
progress bar.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>num_threads</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>concurrency number during the uploadinging</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Mapping">Mapping</span>]</code>
          </td>
          <td></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

<details class="return">
  <summary>Return</summary>
  <p>None:</p>
</details>
      <details class="quote">
        <summary>Source code in <code>aiooss2/resumable.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">resumable_download</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-arguments</span>
    <span class="n">bucket</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;AioBucket&quot;</span><span class="p">,</span> <span class="s2">&quot;CryptoBucket&quot;</span><span class="p">],</span>
    <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span>
    <span class="n">store</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ResumableStore&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">part_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">progress_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">num_threads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">multiget_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resumable download object to local file, implementation method is to</span>
<span class="sd">    create a list temporary files whose name is formed by the original</span>
<span class="sd">    filename with some random surfix. If the downloading was interrupted by</span>
<span class="sd">    some reasons, only those remaied parts need to be downloaded.</span>

<span class="sd">    # Using `CryptoBucket` will make the download fallback to the normal one.</span>
<span class="sd">    # Avoid using multi-threading/processing as the temp downloaded file might</span>
<span class="sd">    # be covered.</span>

<span class="sd">    Args:</span>
<span class="sd">        bucket (Union[AioBucket, CryptoBucket]): bucket object to download</span>
<span class="sd">        key (Union[str, bytes]): object key to store the file</span>
<span class="sd">        filename (Union[str, bytes]): filename to download</span>
<span class="sd">        store (Optional[&quot;ResumableStore&quot;]): ResumableStore object to keep the</span>
<span class="sd">            downloading info in the previous operation.</span>
<span class="sd">        headers (Optional[Mapping]): HTTP headers to send. Defaults to None.</span>
<span class="sd">            # download_part only accept OSS_REQUEST_PAYER</span>
<span class="sd">            # get_object and get_object_to_file only accept OSS_REQUEST_PAYER,</span>
<span class="sd">                OSS_TRAFFIC_LIMIT</span>
<span class="sd">        multipget_threshold (Optional[int]): threshold to use multipart</span>
<span class="sd">            download instead of a normal one.</span>
<span class="sd">        part_size (Optional[int]): partition size of the multipart.</span>
<span class="sd">        progress_callback (Optional[Callable]): callback function for</span>
<span class="sd">            progress bar.</span>
<span class="sd">        num_threads (Optional[int]): concurrency number during the uploadinging</span>
<span class="sd">        params (Optional[Mapping]):</span>

<span class="sd">    Return:</span>
<span class="sd">        None:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key_str</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">to_string</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">filename_str</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Start to resumable download, bucket: </span><span class="si">%s</span><span class="s2">, key: </span><span class="si">%s</span><span class="s2">, filename: </span><span class="si">%s</span><span class="s2">, &quot;</span>
        <span class="s2">&quot;multiget_threshold: </span><span class="si">%s</span><span class="s2">, part_size: </span><span class="si">%s</span><span class="s2">, num_threads: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">bucket</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
        <span class="n">key_str</span><span class="p">,</span>
        <span class="n">filename_str</span><span class="p">,</span>
        <span class="n">multiget_threshold</span><span class="p">,</span>
        <span class="n">part_size</span><span class="p">,</span>
        <span class="n">num_threads</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">multiget_threshold</span> <span class="o">=</span> <span class="n">multiget_threshold</span> <span class="ow">or</span> <span class="n">MULTIGET_THRESHOLD</span>

    <span class="n">valid_headers</span> <span class="o">=</span> <span class="n">_populate_valid_headers</span><span class="p">(</span>
        <span class="n">headers</span><span class="p">,</span> <span class="p">[</span><span class="n">OSS_REQUEST_PAYER</span><span class="p">,</span> <span class="n">OSS_TRAFFIC_LIMIT</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">bucket</span><span class="o">.</span><span class="n">head_object</span><span class="p">(</span>
        <span class="n">key_str</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">valid_headers</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;The size of object to download is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">content_length</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">content_length</span> <span class="o">&gt;=</span> <span class="n">multiget_threshold</span><span class="p">:</span>
        <span class="n">downloader</span> <span class="o">=</span> <span class="n">ResumableDownloader</span><span class="p">(</span>
            <span class="n">bucket</span><span class="p">,</span>
            <span class="n">key</span><span class="p">,</span>
            <span class="n">filename</span><span class="p">,</span>
            <span class="n">_ObjectInfo</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
            <span class="n">part_size</span><span class="o">=</span><span class="n">part_size</span><span class="p">,</span>
            <span class="n">progress_callback</span><span class="o">=</span><span class="n">progress_callback</span><span class="p">,</span>
            <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span>
            <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">valid_headers</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">downloader</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">server_crc</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">bucket</span><span class="o">.</span><span class="n">get_object_to_file</span><span class="p">(</span>
            <span class="n">key_str</span><span class="p">,</span>
            <span class="n">filename_str</span><span class="p">,</span>
            <span class="n">progress_callback</span><span class="o">=</span><span class="n">progress_callback</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">valid_headers</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="aiooss2.resumable.resumable_upload" class="doc doc-heading">
<code class="highlight language-python"><span class="n">resumable_upload</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multipart_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">part_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Resumable upload local file , The implementation is splitting local
files to multipart, storing uploading information in local files. If the
uploading was interrupted by some reasons, only those remaied parts need
to be uploaded.</p>
<h3 id="aiooss2.resumable.resumable_upload--using-cryptobucket-will-make-the-upload-fallback-to-the-normal-one">Using <code>CryptoBucket</code> will make the upload fallback to the normal one.</h3>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>bucket</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<a class="autorefs autorefs-internal" title="aiooss2.api.AioBucket" href="../api/#aiooss2.api.AioBucket">AioBucket</a>, <span title="oss2.CryptoBucket">CryptoBucket</span>]</code>
          </td>
          <td><p>bucket object to upload</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>key</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[str, bytes]</code>
          </td>
          <td><p>object key to store the file</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>filename</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[str, bytes]</code>
          </td>
          <td><p>filename to upload</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>store</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="oss2.resumable.ResumableStore">ResumableStore</span>]</code>
          </td>
          <td><p>ResumableStore object to keep the
uploading info in the previous operation. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>headers</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Mapping">Mapping</span>]</code>
          </td>
          <td><p>HTTP headers to send. Defaults to None.</p>
<h3 id="aiooss2.resumable.resumable_upload--put_object-or-init_multipart_upload-can-make-use-of-the-whole">put_object or init_multipart_upload can make use of the whole</h3>
<pre><code>headers
</code></pre>
<h3 id="aiooss2.resumable.resumable_upload--uplpad_part-only-accept-oss_request_payer-oss_traffic_limit">uplpad_part only accept OSS_REQUEST_PAYER, OSS_TRAFFIC_LIMIT</h3>
<h3 id="aiooss2.resumable.resumable_upload--complete_multipart_upload-only-accept-oss_request_payer">complete_multipart_upload only accept OSS_REQUEST_PAYER,</h3>
<pre><code>OSS_OBJECT_ACL
</code></pre></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>multipart_threshold</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>threshold to use multipart upload
instead of a normal one. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>part_size</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>partition size of the multipart.
Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>progress_callback</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>]</code>
          </td>
          <td><p>callback function for
progress bar. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>num_threads</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>concurrency number during the uploading
Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Mapping">Mapping</span>]</code>
          </td>
          <td><p>Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>PutObjectResult</code></td>          <td>
                <code><span title="oss2.models.PutObjectResult">PutObjectResult</span></code>
          </td>
          <td></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>aiooss2/resumable.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">resumable_upload</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-arguments</span>
    <span class="n">bucket</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;AioBucket&quot;</span><span class="p">,</span> <span class="s2">&quot;CryptoBucket&quot;</span><span class="p">],</span>
    <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span>
    <span class="n">store</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ResumableStore&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">multipart_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">part_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">progress_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">num_threads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PutObjectResult&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resumable upload local file , The implementation is splitting local</span>
<span class="sd">    files to multipart, storing uploading information in local files. If the</span>
<span class="sd">    uploading was interrupted by some reasons, only those remaied parts need</span>
<span class="sd">    to be uploaded.</span>

<span class="sd">    # Using `CryptoBucket` will make the upload fallback to the normal one.</span>

<span class="sd">    Args:</span>
<span class="sd">        bucket (Union[AioBucket, CryptoBucket]): bucket object to upload</span>
<span class="sd">        key (Union[str, bytes]): object key to store the file</span>
<span class="sd">        filename (Union[str, bytes]): filename to upload</span>
<span class="sd">        store (Optional[&quot;ResumableStore&quot;]): ResumableStore object to keep the</span>
<span class="sd">            uploading info in the previous operation. Defaults to None.</span>
<span class="sd">        headers (Optional[Mapping]): HTTP headers to send. Defaults to None.</span>
<span class="sd">            # put_object or init_multipart_upload can make use of the whole</span>
<span class="sd">                headers</span>
<span class="sd">            # uplpad_part only accept OSS_REQUEST_PAYER, OSS_TRAFFIC_LIMIT</span>
<span class="sd">            # complete_multipart_upload only accept OSS_REQUEST_PAYER,</span>
<span class="sd">                OSS_OBJECT_ACL</span>
<span class="sd">        multipart_threshold (Optional[int]): threshold to use multipart upload</span>
<span class="sd">            instead of a normal one. Defaults to None.</span>
<span class="sd">        part_size (Optional[int]): partition size of the multipart.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        progress_callback (Optional[Callable]): callback function for</span>
<span class="sd">            progress bar. Defaults to None.</span>
<span class="sd">        num_threads (Optional[int]): concurrency number during the uploading</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        params (Optional[Mapping]): Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        PutObjectResult:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key_str</span> <span class="o">=</span> <span class="n">to_string</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">filename_str</span> <span class="o">=</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename_str</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Start to resumable upload, bucket: </span><span class="si">%s</span><span class="s2">, key: </span><span class="si">%s</span><span class="s2">, filename: </span><span class="si">%s</span><span class="s2">, &quot;</span>
        <span class="s2">&quot;headers: </span><span class="si">%s</span><span class="s2">, multipart_threshold: </span><span class="si">%s</span><span class="s2">, part_size: </span><span class="si">%s</span><span class="s2">, &quot;</span>
        <span class="s2">&quot;num_threads: </span><span class="si">%s</span><span class="s2">, size of file to upload is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">bucket</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
        <span class="n">key_str</span><span class="p">,</span>
        <span class="n">filename_str</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">,</span>
        <span class="n">multipart_threshold</span><span class="p">,</span>
        <span class="n">part_size</span><span class="p">,</span>
        <span class="n">num_threads</span><span class="p">,</span>
        <span class="n">size</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">multipart_threshold</span> <span class="o">=</span> <span class="n">multipart_threshold</span> <span class="ow">or</span> <span class="n">MULTIPART_THRESHOLD</span>
    <span class="n">num_threads</span> <span class="o">=</span> <span class="n">num_threads</span> <span class="ow">or</span> <span class="n">MULTIPART_NUM_THREADS</span>
    <span class="n">part_size</span> <span class="o">=</span> <span class="n">part_size</span> <span class="ow">or</span> <span class="n">PART_SIZE</span>

    <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;=</span> <span class="n">multipart_threshold</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">CryptoBucket</span><span class="p">):</span>
        <span class="n">store</span> <span class="o">=</span> <span class="n">store</span> <span class="ow">or</span> <span class="n">ResumableStore</span><span class="p">()</span>
        <span class="n">uploader</span> <span class="o">=</span> <span class="n">ResumableUploader</span><span class="p">(</span>
            <span class="n">bucket</span><span class="p">,</span>
            <span class="n">key_str</span><span class="p">,</span>
            <span class="n">filename_str</span><span class="p">,</span>
            <span class="n">size</span><span class="p">,</span>
            <span class="n">store</span><span class="p">,</span>
            <span class="n">part_size</span><span class="o">=</span><span class="n">part_size</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">progress_callback</span><span class="o">=</span><span class="n">progress_callback</span><span class="p">,</span>
            <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">uploader</span><span class="o">.</span><span class="n">upload</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">bucket</span><span class="o">.</span><span class="n">put_object_from_file</span><span class="p">(</span>
            <span class="n">key_str</span><span class="p">,</span>
            <span class="n">filename_str</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">progress_callback</span><span class="o">=</span><span class="n">progress_callback</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../multipart/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Multipart" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Multipart
            </div>
          </div>
        </a>
      
      
        
        <a href="../utils/" class="md-footer__link md-footer__link--next" aria-label="Next: Utils" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Utils
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/iterative/" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.9c69f0bc.min.js"></script>
      
    
  </body>
</html>